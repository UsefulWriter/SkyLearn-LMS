{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{{ package.title }} - {% trans "SCORM Package" %}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <!-- Main content -->
        <div class="col-lg-8">
            <!-- Package header -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-start">
                    <div>
                        <h3 class="mb-1">{{ package.title }}</h3>
                        <div class="text-muted">
                            <i class="fas fa-book"></i> {{ package.course.title }}
                            <span class="mx-2">â€¢</span>
                            <span class="badge bg-info">{{ package.get_version_display }}</span>
                        </div>
                    </div>
                    
                    <!-- Status badge -->
                    <div>
                        {% if package.status == 'ready' %}
                            <span class="badge bg-success fs-6">{% trans "Ready" %}</span>
                        {% elif package.status == 'processing' %}
                            <span class="badge bg-warning fs-6">{% trans "Processing" %}</span>
                        {% elif package.status == 'error' %}
                            <span class="badge bg-danger fs-6">{% trans "Error" %}</span>
                        {% else %}
                            <span class="badge bg-secondary fs-6">{% trans "Pending" %}</span>
                        {% endif %}
                    </div>
                </div>
                
                {% if package.description %}
                <div class="card-body">
                    <p class="card-text">{{ package.description }}</p>
                </div>
                {% endif %}
                
                <!-- Launch button -->
                <div class="card-footer bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="text-muted small">
                            <i class="fas fa-calendar-alt"></i> 
                            {% trans "Uploaded" %} {{ package.created_at|date:"M d, Y" }} 
                            {% trans "by" %} {{ package.uploaded_by.get_full_name|default:package.uploaded_by.username }}
                        </div>
                        
                        <div>
                            {% if package.status == 'ready' %}
                                <!-- Check if user can launch -->
                                {% if not package.allow_multiple_attempts and latest_attempt.lesson_status in 'completed,passed' %}
                                    <button class="btn btn-secondary" disabled title="{% trans 'Already completed - multiple attempts not allowed' %}">
                                        <i class="fas fa-check-circle"></i> {% trans "Completed" %}
                                    </button>
                                {% else %}
                                    <a href="{% url 'scorm:launch' slug=package.slug %}" class="btn btn-primary btn-lg">
                                        <i class="fas fa-play"></i> 
                                        {% if latest_attempt and latest_attempt.lesson_status == 'incomplete' %}
                                            {% trans "Resume" %}
                                        {% else %}
                                            {% trans "Launch" %}
                                        {% endif %}
                                    </a>
                                {% endif %}
                            {% elif package.status == 'error' %}
                                <button class="btn btn-danger" disabled>
                                    <i class="fas fa-exclamation-triangle"></i> {% trans "Error" %}
                                </button>
                            {% else %}
                                <button class="btn btn-secondary" disabled>
                                    <i class="fas fa-hourglass-half"></i> {% trans "Processing" %}
                                </button>
                            {% endif %}
                            
                            <a href="{% url 'scorm:package_list' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left"></i> {% trans "Back" %}
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error message -->
            {% if package.status == 'error' and package.error_message %}
            <div class="alert alert-danger">
                <h6><i class="fas fa-exclamation-triangle"></i> {% trans "Processing Error" %}</h6>
                <p class="mb-0">{{ package.error_message }}</p>
            </div>
            {% endif %}

            <!-- User's progress -->
            {% if user_attempts %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line"></i> {% trans "Your Progress" %}
                    </h5>
                </div>
                <div class="card-body">
                    {% for attempt in user_attempts %}
                    <div class="d-flex justify-content-between align-items-center {% if not forloop.last %}border-bottom pb-3 mb-3{% endif %}">
                        <div>
                            <div class="fw-bold">
                                {% trans "Attempt" %} #{{ forloop.counter }}
                                {% if attempt.lesson_status == 'completed' %}
                                    <span class="badge bg-success ms-2">{% trans "Completed" %}</span>
                                {% elif attempt.lesson_status == 'passed' %}
                                    <span class="badge bg-success ms-2">{% trans "Passed" %}</span>
                                {% elif attempt.lesson_status == 'failed' %}
                                    <span class="badge bg-danger ms-2">{% trans "Failed" %}</span>
                                {% elif attempt.lesson_status == 'incomplete' %}
                                    <span class="badge bg-warning ms-2">{% trans "In Progress" %}</span>
                                {% else %}
                                    <span class="badge bg-secondary ms-2">{{ attempt.get_lesson_status_display }}</span>
                                {% endif %}
                            </div>
                            <div class="text-muted small">
                                <i class="fas fa-calendar"></i> {{ attempt.started_at|date:"M d, Y H:i" }}
                                {% if attempt.completed_at %}
                                    - {% trans "Completed" %} {{ attempt.completed_at|date:"M d, Y H:i" }}
                                {% endif %}
                            </div>
                        </div>
                        <div class="text-end">
                            {% if attempt.score_raw is not None %}
                                <div class="fw-bold text-primary">
                                    {{ attempt.get_percentage_score|floatformat:0 }}%
                                </div>
                                <div class="small text-muted">
                                    {{ attempt.score_raw }}/{{ attempt.score_max }}
                                </div>
                            {% else %}
                                <div class="text-muted">{% trans "No score" %}</div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Admin controls -->
            {% if user.is_superuser %}
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-cogs"></i> {% trans "Admin Controls" %}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="btn-group" role="group">
                        <a href="{% url 'scorm:package_update' slug=package.slug %}" class="btn btn-outline-warning">
                            <i class="fas fa-edit"></i> {% trans "Edit Settings" %}
                        </a>
                        <a href="{% url 'scorm:package_delete' slug=package.slug %}" 
                           class="btn btn-outline-danger"
                           onclick="return confirm('{% trans "Are you sure you want to delete this SCORM package?" %}')">
                            <i class="fas fa-trash"></i> {% trans "Delete Package" %}
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Package Information -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle"></i> {% trans "Package Information" %}
                    </h6>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-5">{% trans "SCORM Version" %}</dt>
                        <dd class="col-sm-7">{{ package.get_version_display }}</dd>
                        
                        <dt class="col-sm-5">{% trans "Course" %}</dt>
                        <dd class="col-sm-7">
                            <a href="{{ package.course.get_absolute_url }}">{{ package.course.title }}</a>
                        </dd>
                        
                        <dt class="col-sm-5">{% trans "Passing Score" %}</dt>
                        <dd class="col-sm-7">{{ package.passing_score }}%</dd>
                        
                        <dt class="col-sm-5">{% trans "Course Weight" %}</dt>
                        <dd class="col-sm-7">{{ package.weight_in_course }}%</dd>
                        
                        <dt class="col-sm-5">{% trans "Multiple Attempts" %}</dt>
                        <dd class="col-sm-7">
                            {% if package.allow_multiple_attempts %}
                                <i class="fas fa-check text-success"></i> {% trans "Allowed" %}
                            {% else %}
                                <i class="fas fa-times text-danger"></i> {% trans "Not Allowed" %}
                            {% endif %}
                        </dd>
                        
                        <dt class="col-sm-5">{% trans "Uploaded" %}</dt>
                        <dd class="col-sm-7">{{ package.created_at|date:"M d, Y H:i" }}</dd>
                        
                        <dt class="col-sm-5">{% trans "File Size" %}</dt>
                        <dd class="col-sm-7">{{ package.package_file.size|filesizeformat }}</dd>
                    </dl>
                </div>
            </div>

            <!-- Progress Summary (for current user) -->
            {% if latest_attempt %}
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-user-check"></i> {% trans "Your Latest Progress" %}
                    </h6>
                </div>
                <div class="card-body text-center">
                    <!-- Status -->
                    <div class="mb-3">
                        {% if latest_attempt.lesson_status == 'completed' %}
                            <i class="fas fa-check-circle fa-3x text-success"></i>
                        {% elif latest_attempt.lesson_status == 'passed' %}
                            <i class="fas fa-award fa-3x text-success"></i>
                        {% elif latest_attempt.lesson_status == 'failed' %}
                            <i class="fas fa-times-circle fa-3x text-danger"></i>
                        {% elif latest_attempt.lesson_status == 'incomplete' %}
                            <i class="fas fa-play-circle fa-3x text-warning"></i>
                        {% else %}
                            <i class="fas fa-question-circle fa-3x text-muted"></i>
                        {% endif %}
                    </div>
                    
                    <h5>{{ latest_attempt.get_lesson_status_display }}</h5>
                    
                    {% if latest_attempt.score_raw is not None %}
                        <p class="mb-2">
                            <strong class="fs-4 text-primary">{{ latest_attempt.get_percentage_score|floatformat:0 }}%</strong>
                        </p>
                        <p class="small text-muted">
                            {{ latest_attempt.score_raw }}/{{ latest_attempt.score_max }} {% trans "points" %}
                        </p>
                    {% endif %}
                    
                    <div class="text-muted small">
                        {% trans "Started" %} {{ latest_attempt.started_at|date:"M d, Y" }}
                        {% if latest_attempt.completed_at %}
                            <br>{% trans "Completed" %} {{ latest_attempt.completed_at|date:"M d, Y" }}
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Statistics (for admin/lecturer) -->
            {% if attempt_stats %}
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-bar"></i> {% trans "Usage Statistics" %}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border-end">
                                <h4 class="text-primary mb-1">{{ attempt_stats.total_attempts|default:0 }}</h4>
                                <small class="text-muted">{% trans "Total Attempts" %}</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <h4 class="text-success mb-1">{{ attempt_stats.completed_attempts|default:0 }}</h4>
                            <small class="text-muted">{% trans "Completed" %}</small>
                        </div>
                    </div>
                    
                    {% if attempt_stats.total_attempts > 0 %}
                    <div class="mt-3">
                        <div class="progress">
                            {% widthratio attempt_stats.completed_attempts attempt_stats.total_attempts 100 as completion_rate %}
                            <div class="progress-bar" role="progressbar" style="width: {{ completion_rate }}%">
                                {{ completion_rate }}%
                            </div>
                        </div>
                        <small class="text-muted">{% trans "Completion Rate" %}</small>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}