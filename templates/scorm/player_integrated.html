{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{{ package.title }} - {{ package.course.title }}{% endblock %}

{% block extra_css %}
<style>
/* Full screen layout adjustments */
body {
    overflow-x: hidden;
}

.container-fluid.main-content {
    max-width: 100% !important;
    padding: 0 !important;
}

.scorm-module-container {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    overflow: hidden;
    margin: 0 15px;
}

.scorm-module-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
}

.scorm-module-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.scorm-module-title {
    font-size: 24px;
    font-weight: 600;
    margin: 0;
}

.scorm-module-meta {
    display: flex;
    gap: 20px;
    font-size: 14px;
    opacity: 0.9;
}

.scorm-progress-bar {
    background: rgba(255,255,255,0.2);
    border-radius: 4px;
    height: 8px;
    overflow: hidden;
    margin-top: 15px;
}

.scorm-progress-fill {
    background: #4ade80;
    height: 100%;
    width: 0%;
    transition: width 0.3s ease;
}

.scorm-content-wrapper {
    position: relative;
    background: #f8f9fa;
    min-height: calc(100vh - 200px);
    display: flex;
    align-items: stretch;
    justify-content: center;
    padding: 0;
}

.scorm-iframe {
    width: 100%;
    height: calc(100vh - 200px);
    min-height: 700px;
    border: none;
    display: block;
}

.scorm-sidebar {
    background: white;
    padding: 20px;
    border-left: 1px solid #e5e7eb;
    height: calc(100vh - 200px);
    min-height: 700px;
    overflow-y: auto;
    position: sticky;
    top: 0;
}

.scorm-sidebar h6 {
    color: #6b7280;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 15px;
}

.scorm-status-card {
    background: #f3f4f6;
    border-radius: 6px;
    padding: 15px;
    margin-bottom: 15px;
}

.scorm-status-label {
    color: #6b7280;
    font-size: 13px;
    margin-bottom: 5px;
}

.scorm-status-value {
    font-size: 18px;
    font-weight: 600;
    color: #111827;
}

.scorm-action-buttons {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.scorm-action-buttons .btn {
    flex: 1;
}

.status-indicator {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 5px;
}

.status-indicator.incomplete { background: #fbbf24; }
.status-indicator.completed { background: #4ade80; }
.status-indicator.passed { background: #10b981; }
.status-indicator.failed { background: #ef4444; }

.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255,255,255,0.95);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10;
}

.loading-content {
    text-align: center;
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #e5e7eb;
    border-top-color: #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Responsive adjustments */
@media (max-width: 991px) {
    .scorm-iframe {
        height: calc(100vh - 250px);
        min-height: 500px;
    }
    
    .scorm-content-wrapper {
        min-height: calc(100vh - 250px);
    }
    
    .scorm-sidebar {
        height: auto;
        min-height: auto;
        position: relative;
    }
}

/* Full width on mobile */
@media (max-width: 767px) {
    .scorm-module-container {
        margin: 0;
        border-radius: 0;
    }
    
    .scorm-iframe {
        height: 60vh;
        min-height: 400px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid main-content">

<!-- Breadcrumb Navigation -->
<nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">{% trans 'Home' %}</a></li>
        <li class="breadcrumb-item"><a href="{% url 'programs' %}">{% trans 'Programs' %}</a></li>
        <li class="breadcrumb-item"><a href="{% url 'program_detail' package.course.program.id %}">{{ package.course.program }}</a></li>
        <li class="breadcrumb-item"><a href="{% url 'course_detail' package.course.slug %}">{{ package.course }}</a></li>
        <li class="breadcrumb-item active" aria-current="page">{{ package.title }}</li>
    </ol>
</nav>

<!-- SCORM Module Container -->
<div class="scorm-module-container">
    <!-- Module Header -->
    <div class="scorm-module-header">
        <div class="scorm-module-info">
            <div>
                <h1 class="scorm-module-title">{{ package.title }}</h1>
                <p class="mb-0 mt-2">{{ package.description|default:"Interactive SCORM Learning Module" }}</p>
            </div>
            <div class="scorm-module-meta">
                <span><i class="fas fa-book-open me-1"></i> {{ package.course.title }}</span>
                <span><i class="fas fa-clock me-1"></i> <span id="timeSpent">00:00</span></span>
            </div>
        </div>
        
        <!-- Progress Bar -->
        <div class="scorm-progress-bar">
            <div class="scorm-progress-fill" id="progressBar"></div>
        </div>
    </div>

    <!-- Content Area -->
    <div class="row g-0">
        <div class="col-xl-10 col-lg-9 col-md-8">
            <div class="scorm-content-wrapper">
                <!-- Loading Overlay -->
                <div class="loading-overlay" id="loadingOverlay">
                    <div class="loading-content">
                        <div class="loading-spinner"></div>
                        <p class="mt-3 text-muted">{% trans "Loading module..." %}</p>
                    </div>
                </div>
                
                <!-- SCORM Content Frame -->
                <iframe 
                    id="scormFrame" 
                    class="scorm-iframe"
                    src="{{ launch_url }}"
                    onload="onScormLoad()"
                    allow="autoplay; fullscreen">
                </iframe>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="col-xl-2 col-lg-3 col-md-4">
            <div class="scorm-sidebar">
                <h6>{% trans "Learning Progress" %}</h6>
                
                <!-- Status Card -->
                <div class="scorm-status-card">
                    <div class="scorm-status-label">{% trans "Status" %}</div>
                    <div class="scorm-status-value">
                        <span class="status-indicator incomplete" id="statusIndicator"></span>
                        <span id="statusText">{% trans "In Progress" %}</span>
                    </div>
                </div>
                
                <!-- Score Card -->
                <div class="scorm-status-card" id="scoreCard" style="display:none;">
                    <div class="scorm-status-label">{% trans "Score" %}</div>
                    <div class="scorm-status-value">
                        <span id="scoreValue">-</span>%
                    </div>
                </div>
                
                <!-- Attempts Card -->
                {% if package.allow_multiple_attempts %}
                <div class="scorm-status-card">
                    <div class="scorm-status-label">{% trans "Attempts" %}</div>
                    <div class="scorm-status-value">
                        {{ attempt_count }} / {% if package.max_attempts %}{{ package.max_attempts }}{% else %}âˆž{% endif %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Passing Score -->
                <div class="scorm-status-card">
                    <div class="scorm-status-label">{% trans "Passing Score" %}</div>
                    <div class="scorm-status-value">{{ package.passing_score }}%</div>
                </div>
                
                <!-- Action Buttons -->
                <div class="scorm-action-buttons">
                    <button class="btn btn-outline-primary" onclick="saveProgress()">
                        <i class="fas fa-save"></i> {% trans "Save" %}
                    </button>
                    <button class="btn btn-outline-danger" onclick="exitModule()">
                        <i class="fas fa-sign-out-alt"></i> {% trans "Exit" %}
                    </button>
                </div>
                
                <!-- Module Information -->
                <hr class="my-4">
                <h6>{% trans "Module Information" %}</h6>
                <div class="small text-muted">
                    <p><strong>{% trans "Version" %}:</strong> {{ package.get_version_display }}</p>
                    <p><strong>{% trans "Weight" %}:</strong> {{ package.weight_in_course }}%</p>
                    <p><strong>{% trans "Updated" %}:</strong> {{ package.updated_at|date:"M d, Y" }}</p>
                </div>
                
                <!-- Related Modules -->
                {% if other_packages %}
                <hr class="my-4">
                <h6>{% trans "Other Modules" %}</h6>
                <div class="list-group list-group-flush">
                    {% for other in other_packages %}
                    <a href="{% url 'scorm:launch' slug=other.slug %}" class="list-group-item list-group-item-action">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>{{ other.title|truncatechars:25 }}</span>
                            {% if other.id in completed_packages %}
                            <i class="fas fa-check-circle text-success"></i>
                            {% endif %}
                        </div>
                    </a>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

</div>
<!-- Hidden data for JavaScript -->
<script type="application/json" id="scorm-data">
{
    "attemptId": {{ attempt.id }},
    "packageId": {{ package.id }},
    "packageSlug": "{{ package.slug }}",
    "apiUrl": "{{ scorm_api_url }}",
    "courseUrl": "{% url 'course_detail' package.course.slug %}",
    "scormVersion": "{{ package.version }}",
    "csrfToken": "{{ csrf_token }}",
    "passingScore": {{ package.passing_score }}
}
</script>

{% endblock %}

{% block extra_js %}
<script>
// Global variables
let scormData = null;
let scormAPI = null;
let heartbeatInterval = null;
let timeInterval = null;
let startTime = Date.now();

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    scormData = JSON.parse(document.getElementById('scorm-data').textContent);
    initializeScormAPI();
    startTimers();
});

function initializeScormAPI() {
    // Create appropriate API version
    if (scormData.scormVersion === '1.2') {
        scormAPI = new SCORM12API();
    } else {
        scormAPI = new SCORM2004API();
    }
    
    // Make API available globally
    window.API = scormAPI;
    window.API_1484_11 = scormAPI;
    
    // Try to inject into iframe
    setTimeout(() => attachAPIToIframe(), 100);
}

function attachAPIToIframe() {
    try {
        const frame = document.getElementById('scormFrame');
        if (frame && frame.contentWindow) {
            frame.contentWindow.API = scormAPI;
            frame.contentWindow.API_1484_11 = scormAPI;
        }
    } catch (e) {
        console.log('Waiting for iframe...');
        setTimeout(() => attachAPIToIframe(), 200);
    }
}

function onScormLoad() {
    // Hide loading overlay
    document.getElementById('loadingOverlay').style.display = 'none';
    
    // Inject API again to be sure
    attachAPIToIframe();
    
    console.log('SCORM module loaded');
}

function startTimers() {
    // Update time spent
    timeInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        document.getElementById('timeSpent').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }, 1000);
    
    // Auto-save every 30 seconds
    heartbeatInterval = setInterval(() => {
        if (scormAPI) scormAPI.LMSCommit('');
    }, 30000);
}

function updateStatus(status) {
    const statusText = document.getElementById('statusText');
    const indicator = document.getElementById('statusIndicator');
    
    const statusMap = {
        'incomplete': { text: '{% trans "In Progress" %}', class: 'incomplete' },
        'completed': { text: '{% trans "Completed" %}', class: 'completed' },
        'passed': { text: '{% trans "Passed" %}', class: 'passed' },
        'failed': { text: '{% trans "Failed" %}', class: 'failed' }
    };
    
    if (statusMap[status]) {
        statusText.textContent = statusMap[status].text;
        indicator.className = `status-indicator ${statusMap[status].class}`;
    }
}

function updateScore(score) {
    const scoreCard = document.getElementById('scoreCard');
    const scoreValue = document.getElementById('scoreValue');
    
    if (score !== null && score !== undefined) {
        scoreCard.style.display = 'block';
        scoreValue.textContent = Math.round(score);
        
        // Update progress bar
        const progressBar = document.getElementById('progressBar');
        progressBar.style.width = `${Math.min(score, 100)}%`;
        
        // Check if passed
        if (score >= scormData.passingScore) {
            updateStatus('passed');
        }
    }
}

function saveProgress() {
    if (scormAPI) {
        scormAPI.LMSCommit('');
        alert('{% trans "Progress saved successfully!" %}');
    }
}

function exitModule() {
    if (confirm('{% trans "Are you sure you want to exit? Your progress will be saved." %}')) {
        if (scormAPI) {
            scormAPI.LMSCommit('');
            scormAPI.LMSFinish('');
        }
        
        // Clear intervals
        if (heartbeatInterval) clearInterval(heartbeatInterval);
        if (timeInterval) clearInterval(timeInterval);
        
        // Redirect to course page
        window.location.href = scormData.courseUrl;
    }
}

// Handle page unload
window.addEventListener('beforeunload', function(e) {
    if (scormAPI && scormAPI.initialized && !scormAPI.terminated) {
        scormAPI.LMSCommit('');
        scormAPI.LMSFinish('');
    }
});

// SCORM 1.2 API Implementation
class SCORM12API {
    constructor() {
        this.data = {};
        this.initialized = false;
        this.terminated = false;
    }
    
    LMSInitialize(parameter) {
        if (this.initialized) return 'false';
        this.initialized = true;
        updateStatus('incomplete');
        return 'true';
    }
    
    LMSFinish(parameter) {
        if (!this.initialized || this.terminated) return 'false';
        this.LMSCommit('');
        this.terminated = true;
        this.sendToServer('finish', {});
        return 'true';
    }
    
    LMSGetValue(element) {
        if (!this.initialized || this.terminated) return '';
        return this.data[element] || '';
    }
    
    LMSSetValue(element, value) {
        if (!this.initialized || this.terminated) return 'false';
        this.data[element] = value;
        
        // Update UI based on element
        if (element === 'cmi.core.lesson_status') {
            updateStatus(value);
        } else if (element === 'cmi.core.score.raw') {
            updateScore(value);
        }
        
        return 'true';
    }
    
    LMSCommit(parameter) {
        if (!this.initialized || this.terminated) return 'false';
        this.sendToServer('commit', this.data);
        return 'true';
    }
    
    LMSGetLastError() { return '0'; }
    LMSGetErrorString(errorCode) { return 'No error'; }
    LMSGetDiagnostic(errorCode) { return 'No diagnostic'; }
    
    sendToServer(action, data) {
        fetch(scormData.apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': scormData.csrfToken
            },
            body: JSON.stringify({
                action: action,
                attempt_id: scormData.attemptId,
                data: data
            })
        }).catch(error => console.error('SCORM API error:', error));
    }
}

// SCORM 2004 API
class SCORM2004API extends SCORM12API {
    Initialize(parameter) { return this.LMSInitialize(parameter); }
    Terminate(parameter) { return this.LMSFinish(parameter); }
    GetValue(element) { return this.LMSGetValue(element); }
    SetValue(element, value) { return this.LMSSetValue(element, value); }
    Commit(parameter) { return this.LMSCommit(parameter); }
    GetLastError() { return this.LMSGetLastError(); }
    GetErrorString(errorCode) { return this.LMSGetErrorString(errorCode); }
    GetDiagnostic(errorCode) { return this.LMSGetDiagnostic(errorCode); }
}
</script>
{% endblock %}